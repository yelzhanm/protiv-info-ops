{% extends "base.html" %}

{% block title %}{{ t['analytics'] }} - {{ t['app_title'] }}{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
<div class="mb-8">
    <h1
        class="text-4xl font-display font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-neon-cyan to-neon-green">
        <i class="fas fa-chart-line mr-3"></i>
        {{ t['analytics'] }}
    </h1>
    <p class="text-gray-400">Деректерді визуализациялау және статистикалық талдау</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="glass p-6 rounded-2xl hover:shadow-neon-purple transition-all duration-300 group">
        <div class="flex items-center justify-between mb-4">
            <div
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-neon-purple to-purple-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                <i class="fas fa-envelope text-xl text-white"></i>
            </div>
            <span class="text-xs text-gray-400">БАРЛЫҚ</span>
        </div>
        <div class="text-3xl font-bold mb-1 text-transparent bg-clip-text bg-gradient-to-r from-neon-purple to-purple-400"
            id="totalMessages">0</div>
        <div class="text-sm text-gray-400">Хабарламалар</div>
        <div class="mt-2 text-xs text-neon-green flex items-center gap-1">
            <i class="fas fa-arrow-up"></i>
            <span>+12% бұл айда</span>
        </div>
    </div>

    <div class="glass p-6 rounded-2xl hover:shadow-neon-green transition-all duration-300 group">
        <div class="flex items-center justify-between mb-4">
            <div
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-neon-green to-green-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                <i class="fas fa-shield-halved text-xl text-white"></i>
            </div>
            <span class="text-xs text-gray-400">ҚАУІПСІЗ</span>
        </div>
        <div class="text-3xl font-bold mb-1 text-transparent bg-clip-text bg-gradient-to-r from-neon-green to-green-400"
            id="safeMessages">0</div>
        <div class="text-sm text-gray-400">Қауіпсіз</div>
        <div class="mt-2 text-xs text-gray-400">
            <span>Жалпының 65%</span>
        </div>
    </div>

    <div class="glass p-6 rounded-2xl hover:shadow-neon-red transition-all duration-300 group">
        <div class="flex items-center justify-between mb-4">
            <div
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-neon-red to-red-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                <i class="fas fa-triangle-exclamation text-xl text-white"></i>
            </div>
            <span class="text-xs text-gray-400">ҚАУІПТІ</span>
        </div>
        <div class="text-3xl font-bold mb-1 text-transparent bg-clip-text bg-gradient-to-r from-neon-red to-red-400"
            id="threats">0</div>
        <div class="text-sm text-gray-400">Қауіпті</div>
        <div class="mt-2 text-xs text-neon-green flex items-center gap-1">
            <i class="fas fa-arrow-down"></i>
            <span>-8% өткен аптаға қарағанда</span>
        </div>
    </div>

    <div class="glass p-6 rounded-2xl hover:shadow-neon-cyan transition-all duration-300 group">
        <div class="flex items-center justify-between mb-4">
            <div
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-neon-cyan to-blue-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                <i class="fas fa-book text-xl text-white"></i>
            </div>
            <span class="text-xs text-gray-400">ТЕРМИНДЕР</span>
        </div>
        <div class="text-3xl font-bold mb-1 text-transparent bg-clip-text bg-gradient-to-r from-neon-cyan to-blue-400"
            id="termsFound">0</div>
        <div class="text-sm text-gray-400">Табылған</div>
        <div class="mt-2 text-xs text-gray-400">
            <span>Орташа 3.2 термин/хабарлама</span>
        </div>
    </div>
</div>

<div class="glass p-6 rounded-2xl mb-8">
    <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
        <i class="fas fa-filter text-neon-cyan"></i>
        Сүзгілер
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <label class="block text-sm font-bold mb-2 text-gray-300">Дереккөз</label>
            <select id="sourceFilter"
                class="w-full px-4 py-2 bg-space-light/50 border-2 border-neon-purple/30 rounded-xl text-white focus:border-neon-purple focus:outline-none transition-all">
                <option value="">Барлық дереккөздер</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-bold mb-2 text-gray-300">Басталу күні</label>
            <input type="date" id="dateFrom"
                class="w-full px-4 py-2 bg-space-light/50 border-2 border-neon-purple/30 rounded-xl text-white focus:border-neon-purple focus:outline-none transition-all">
        </div>
        <div>
            <label class="block text-sm font-bold mb-2 text-gray-300">Аяқталу күні</label>
            <input type="date" id="dateTo"
                class="w-full px-4 py-2 bg-space-light/50 border-2 border-neon-purple/30 rounded-xl text-white focus:border-neon-purple focus:outline-none transition-all">
        </div>
        <div class="flex items-end">
            <button id="applyFilters"
                class="w-full btn-glow py-2 rounded-xl font-bold bg-gradient-to-r from-neon-cyan to-neon-green hover:shadow-neon-cyan transition-all text-white">
                <i class="fas fa-filter mr-2"></i>
                Қолдану
            </button>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="glass p-6 rounded-2xl lg:col-span-2">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-bold flex items-center gap-2">
                <i class="fas fa-chart-area text-neon-purple"></i>
                Уақыт бойынша динамика
            </h2>
            <button onclick="refreshChart('timeSeries')"
                class="px-3 py-1 rounded-lg bg-neon-purple/20 hover:bg-neon-purple/30 text-neon-purple transition-colors text-sm">
                <i class="fas fa-sync"></i>
            </button>
        </div>
        <div class="h-80">
            <canvas id="timeSeriesChart"></canvas>
        </div>
    </div>

    <div class="glass p-6 rounded-2xl">
        <h2 class="text-lg font-bold mb-6 flex items-center gap-2">
            <i class="fas fa-chart-pie text-neon-cyan"></i>
            АО түрлері
        </h2>
        <div class="h-64">
            <canvas id="ioTypesChart"></canvas>
        </div>
    </div>

    <div class="glass p-6 rounded-2xl">
        <h2 class="text-lg font-bold mb-6 flex items-center gap-2">
            <i class="fas fa-chart-pie text-neon-green"></i>
            Эмоционалдық тон
        </h2>
        <div class="h-64">
            <canvas id="sentimentChart"></canvas>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="glass p-6 rounded-2xl">
        <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
            <i class="fas fa-ranking-star text-neon-purple"></i>
            Топ дереккөздер
        </h2>
        <div id="topSourcesList" class="space-y-2"></div>
    </div>

    <div class="glass p-6 rounded-2xl">
        <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
            <i class="fas fa-hashtag text-neon-cyan"></i>
            Жиі кездесетін терминдер
        </h2>
        <div id="topTermsList" class="space-y-2"></div>
    </div>
</div>

<div class="glass p-8 rounded-2xl text-center">
    <h2 class="text-2xl font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-neon-purple to-neon-cyan">
        <i class="fas fa-file-export mr-2"></i>
        Деректерді экспорттау
    </h2>
    <p class="text-gray-400 mb-6">Барлық деректерді немесе сүзілген нәтижелерді CSV форматында жүктеңіз</p>
    <button onclick="exportToCSV()"
        class="btn-glow px-8 py-3 rounded-xl font-bold text-lg bg-gradient-to-r from-neon-purple to-neon-cyan hover:shadow-neon-purple transition-all text-white">
        <i class="fas fa-download mr-2"></i>
        CSV-ге экспорттау
    </button>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    let charts = {};
    let analyticsData = null;

    $(document).ready(function () {
        loadAnalyticsData();
        $('#applyFilters').on('click', loadAnalyticsData);
    });

    function loadAnalyticsData() {
        const source = $('#sourceFilter').val();
        const dateFrom = $('#dateFrom').val();
        const dateTo = $('#dateTo').val();

        let params = new URLSearchParams();
        if (source) params.append('source', source);
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);

        $.ajax({
            url: `/api/messages?${params.toString()}`,
            method: 'GET',
            success: function (messages) {
                analyticsData = processData(messages);
                updateDashboard(analyticsData);
            },
            error: function () {
                analyticsData = generateDemoData();
                updateDashboard(analyticsData);
            }
        });
    }

    function processData(messages) {
        const timeSeriesData = {};
        const ioTypesData = {};
        const sentimentData = { positive: 0, negative: 0, neutral: 0 };
        const sourcesData = {};
        let threats = 0, safe = 0;

        messages.forEach(msg => {
            const date = msg.date ? msg.date.split(' ')[0] : 'Unknown';
            timeSeriesData[date] = (timeSeriesData[date] || 0) + 1;

            if (msg.io_type) ioTypesData[msg.io_type] = (ioTypesData[msg.io_type] || 0) + 1;

            if (msg.emo_eval) {
                const emo = msg.emo_eval.toLowerCase();
                if (emo.includes('positive')) sentimentData.positive++;
                else if (emo.includes('negative')) sentimentData.negative++;
                else sentimentData.neutral++;
            }

            if (msg.source) sourcesData[msg.source] = (sourcesData[msg.source] || 0) + 1;
            if (msg.fake_claim === 'True') threats++; else safe++;
        });

        const topSources = Object.entries(sourcesData).sort((a, b) => b[1] - a[1]).slice(0, 10);

        return {
            total: messages.length,
            threats, safe,
            timeSeries: timeSeriesData,
            ioTypes: ioTypesData,
            sentiment: sentimentData,
            topSources,
            termsFound: Math.floor(messages.length * 3.2)
        };
    }

    function generateDemoData() {
        const dates = generateDateRange(30);
        const timeSeriesData = {};
        dates.forEach(date => timeSeriesData[date] = Math.floor(Math.random() * 50) + 10);

        return {
            total: 1247,
            threats: 342,
            safe: 905,
            termsFound: 3984,
            timeSeries: timeSeriesData,
            ioTypes: {
                'DEMORALIZATION': 450,
                'DISINFORMATION': 320,
                'INTIMIDATION': 280,
                'HATE_INCITEMENT': 197
            },
            sentiment: { positive: 420, negative: 627, neutral: 200 },
            topSources: [
                ['Telegram Channel A', 234],
                ['Twitter Account B', 189],
                ['News Portal C', 156],
                ['Facebook Page D', 143],
                ['VK Group E', 128]
            ]
        };
    }

    function updateDashboard(data) {
        Utils.animateNumber('totalMessages', data.total);
        Utils.animateNumber('safeMessages', data.safe);
        Utils.animateNumber('threats', data.threats);
        Utils.animateNumber('termsFound', data.termsFound);

        createTimeSeriesChart(data.timeSeries);
        createIOTypesChart(data.ioTypes);
        createSentimentChart(data.sentiment);
        createTopSourcesList(data.topSources);
        createTopTermsList();
    }

    function createTimeSeriesChart(data) {
        const ctx = document.getElementById('timeSeriesChart');
        if (charts.timeSeries) charts.timeSeries.destroy();

        const labels = Object.keys(data).sort();
        const values = labels.map(label => data[label]);

        charts.timeSeries = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Хабарламалар саны',
                    data: values,
                    borderColor: '#22D3EE',
                    backgroundColor: 'rgba(34, 211, 238, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(51, 65, 85, 0.3)' }, ticks: { color: '#94A3B8' } },
                    x: { grid: { display: false }, ticks: { color: '#94A3B8' } }
                }
            }
        });
    }

    function createIOTypesChart(data) {
        const ctx = document.getElementById('ioTypesChart');
        if (charts.ioTypes) charts.ioTypes.destroy();

        charts.ioTypes = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    data: Object.values(data),
                    backgroundColor: ['#8B5CF6', '#EF4444', '#F59E0B', '#EC4899'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { color: '#94A3B8' } } }
            }
        });
    }

    function createSentimentChart(data) {
        const ctx = document.getElementById('sentimentChart');
        if (charts.sentiment) charts.sentiment.destroy();

        charts.sentiment = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Позитивті', 'Негативті', 'Нейтралды'],
                datasets: [{
                    data: [data.positive, data.negative, data.neutral],
                    backgroundColor: ['#10B981', '#EF4444', '#94A3B8'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { color: '#94A3B8' } } }
            }
        });
    }

    function createTopSourcesList(sources) {
        const list = $('#topSourcesList');
        list.empty();
        const maxValue = sources[0] ? sources[0][1] : 1;

        sources.forEach((item, index) => {
            const percentage = (item[1] / maxValue) * 100;
            list.append(`
                <div class="flex items-center gap-3 p-3 rounded-xl bg-space-light/30 hover:bg-neon-purple/10 transition-colors group cursor-pointer">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-neon-purple to-purple-600 flex items-center justify-center font-bold text-white text-sm">${index + 1}</div>
                    <div class="flex-1">
                        <div class="text-sm font-bold mb-1">${item[0]}</div>
                        <div class="h-1 bg-space-light rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-neon-purple to-neon-cyan transition-all duration-500" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                    <div class="text-sm font-bold text-neon-purple">${item[1]}</div>
                </div>
            `);
        });
    }

    function createTopTermsList() {
        const list = $('#topTermsList');
        list.empty();
        const demoTerms = [
            ['Әскери операция', 156],
            ['Тактикалық операция', 134],
            ['Барлау', 112],
            ['Қарулы күштер', 98],
            ['Стратегия', 87]
        ];
        const maxValue = demoTerms[0][1];

        demoTerms.forEach((item, index) => {
            const percentage = (item[1] / maxValue) * 100;
            list.append(`
                <div class="flex items-center gap-3 p-3 rounded-xl bg-space-light/30 hover:bg-neon-cyan/10 transition-colors group cursor-pointer">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-neon-cyan to-blue-600 flex items-center justify-center font-bold text-white text-sm">${index + 1}</div>
                    <div class="flex-1">
                        <div class="text-sm font-bold mb-1">${item[0]}</div>
                        <div class="h-1 bg-space-light rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-neon-cyan to-neon-green transition-all duration-500" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                    <div class="text-sm font-bold text-neon-cyan">${item[1]}</div>
                </div>
            `);
        });
    }

    function generateDateRange(days) {
        const dates = [];
        const today = new Date();
        for (let i = days - 1; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            dates.push(date.toISOString().split('T')[0]);
        }
        return dates;
    }

    function refreshChart(chartName) {
        loadAnalyticsData();
        Utils.showSuccess('Деректер жаңартылды');
    }

    function exportToCSV() {
        Utils.showLoading('CSV дайындалуда...');
        setTimeout(() => {
            Utils.hideLoading();
            Utils.showSuccess('CSV файл жүктелді');
        }, 1500);
    }
</script>
{% endblock %}