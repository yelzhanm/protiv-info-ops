{% extends "base.html" %}

{% block title %}{{ t['admin_panel'] }} - {{ t['app_title'] }}{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-8">
  <h1
    class="text-4xl font-display font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-neon-purple to-neon-cyan">
    <i class="fas fa-user-shield mr-3"></i>
    {{ t['admin_panel'] }}
  </h1>
  <p class="text-gray-400">Хабарламаларды талдау және басқару</p>
</div>

<!-- Main Grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

  <!-- Left: NLP Analysis Form -->
  <div class="lg:col-span-1">
    <div class="glass p-6 rounded-2xl sticky top-24">
      <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
        <i class="fas fa-robot text-neon-cyan"></i>
        {{ t['nlp_analysis'] }}
      </h2>

      <form id="analysisForm" class="space-y-4">
        <!-- Text Input -->
        <div>
          <label class="block text-sm font-bold mb-2 text-gray-300">{{ t['text'] }}</label>
          <textarea id="textInput" rows="6"
            class="w-full px-4 py-3 bg-space-light/50 border-2 border-neon-purple/30 rounded-xl text-white placeholder-gray-500 focus:border-neon-purple focus:shadow-neon-purple focus:outline-none transition-all resize-none"
            placeholder="{{ t['enter_text'] }}" required></textarea>
        </div>

        <!-- Channel & Date -->
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-bold mb-2 text-gray-300">{{ t['channel'] }}</label>
            <input type="text" id="channelInput" value="Manual Input"
              class="w-full px-4 py-2 bg-space-light/50 border-2 border-neon-purple/30 rounded-xl text-white focus:border-neon-purple focus:shadow-neon-purple focus:outline-none transition-all">
          </div>
          <div>
            <label class="block text-sm font-bold mb-2 text-gray-300">{{ t['date'] }}</label>
            <input type="datetime-local" id="dateInput"
              class="w-full px-4 py-2 bg-space-light/50 border-2 border-neon-purple/30 rounded-xl text-white focus:border-neon-purple focus:shadow-neon-purple focus:outline-none transition-all">
          </div>
        </div>

        <!-- Submit Button -->
        <button type="submit"
          class="w-full btn-glow py-3 rounded-xl font-bold bg-gradient-to-r from-neon-purple to-neon-cyan hover:shadow-neon-purple transition-all text-white flex items-center justify-center gap-2 group">
          <i class="fas fa-microscope"></i>
          <span>{{ t['analyze'] }}</span>
          <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
        </button>
      </form>

      <!-- Analysis Results -->
      <div id="analysisResults" class="mt-6 hidden space-y-4">
        <div class="h-px bg-gradient-to-r from-transparent via-neon-purple to-transparent"></div>

        <!-- General Info -->
        <div class="glass p-4 rounded-xl border border-neon-purple/20">
          <h3 class="text-sm font-bold mb-3 text-neon-cyan flex items-center gap-2">
            <i class="fas fa-info-circle"></i>
            Жалпы ақпарат
          </h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-400">IO түрі:</span>
              <span id="resIOType" class="font-bold text-neon-purple"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Фейк:</span>
              <span id="resFakeClaim"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Эмоция:</span>
              <span id="resEmotion"></span>
            </div>
          </div>
        </div>

        <!-- NER Entities -->
        <div class="glass p-4 rounded-xl border border-neon-cyan/20">
          <h3 class="text-sm font-bold mb-3 text-neon-cyan flex items-center gap-2">
            <i class="fas fa-tags"></i>
            Атаулар (NER)
          </h3>
          <div id="resEntities" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Terms -->
        <div class="glass p-4 rounded-xl border border-neon-green/20">
          <h3 class="text-sm font-bold mb-3 text-neon-green flex items-center gap-2">
            <i class="fas fa-book"></i>
            Әскери терминдер
          </h3>
          <div id="resTerms" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- LLM Summary -->
        <div class="glass p-4 rounded-xl border border-neon-purple/20">
          <h3 class="text-sm font-bold mb-3 text-neon-purple flex items-center gap-2">
            <i class="fas fa-brain"></i>
            LLM талдауы
          </h3>
          <p id="resSummary" class="text-sm text-gray-400 mb-2"></p>
          <div id="resThreat" class="text-sm"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Right: Message Feed -->
  <div class="lg:col-span-2">
    <div class="glass p-6 rounded-2xl">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold flex items-center gap-2">
          <i class="fas fa-stream text-neon-green"></i>
          {{ t['message_feed'] }}
        </h2>
        <span class="px-3 py-1 rounded-full bg-neon-green/20 text-neon-green text-sm font-bold">
          {{ data|length }} хабарлама
        </span>
      </div>

      <!-- Table -->
      <div class="overflow-x-auto">
        <table id="messageTable" class="w-full">
          <thead>
            <tr class="text-left text-xs text-gray-400 uppercase tracking-wider">
              <th class="pb-3">{{ t['source'] }}</th>
              <th class="pb-3">{{ t['date'] }}</th>
              <th class="pb-3">{{ t['text'] }}</th>
              <th class="pb-3">{{ t['io_type'] }}</th>
              <th class="pb-3">Эмоция</th>
              <th class="pb-3">Фейк</th>
              <th class="pb-3">Әрекет</th>
            </tr>
          </thead>
          <tbody class="space-y-2">
            {% for item in data %}
            <tr class="group cursor-pointer" data-id="{{ item.id }}" data-source="{{ item.source or '—' }}"
              data-date="{{ item.date or '—' }}" data-text="{{ item.text or '—' }}" data-io="{{ item.io_type or '—' }}"
              data-emo="{{ item.emo_eval or '—' }}" data-fake="{{ item.fake_claim or '—' }}">
              <td class="py-3 rounded-l-xl bg-space-light/30 group-hover:bg-neon-purple/10 transition-colors px-3">
                <span class="text-sm">{{ item.source or '—' }}</span>
              </td>
              <td class="py-3 bg-space-light/30 group-hover:bg-neon-purple/10 transition-colors px-3">
                <span class="text-xs text-gray-400">{{ item.date[:16] if item.date else '—' }}</span>
              </td>
              <td class="py-3 bg-space-light/30 group-hover:bg-neon-purple/10 transition-colors px-3">
                <span class="text-sm truncate max-w-xs block">{{ item.text[:50] if item.text else '—' }}...</span>
              </td>
              <td class="py-3 bg-space-light/30 group-hover:bg-neon-purple/10 transition-colors px-3">
                {% if item.io_type %}
                <span
                  class="px-2 py-1 rounded-lg bg-neon-purple/20 text-neon-purple text-xs font-bold border border-neon-purple/30">
                  {{ item.io_type[:15] }}
                </span>
                {% else %}
                <span class="text-gray-500">—</span>
                {% endif %}
              </td>
              <td class="py-3 bg-space-light/30 group-hover:bg-neon-purple/10 transition-colors px-3">
                <span class="text-sm">{{ item.emo_eval or '—' }}</span>
              </td>
              <td class="py-3 bg-space-light/30 group-hover:bg-neon-purple/10 transition-colors px-3">
                {% if item.fake_claim == 'True' %}
                <span
                  class="px-2 py-1 rounded-lg bg-neon-red/20 text-neon-red text-xs font-bold border border-neon-red/30">
                  {{ t['true'] }}
                </span>
                {% elif item.fake_claim == 'False' %}
                <span
                  class="px-2 py-1 rounded-lg bg-neon-green/20 text-neon-green text-xs font-bold border border-neon-green/30">
                  {{ t['false'] }}
                </span>
                {% else %}
                <span class="text-gray-500">—</span>
                {% endif %}
              </td>
              <td class="py-3 rounded-r-xl bg-space-light/30 group-hover:bg-neon-purple/10 transition-colors px-3">
                <button
                  class="delete-btn px-3 py-1 rounded-lg bg-neon-red/20 hover:bg-neon-red/30 text-neon-red transition-colors text-xs"
                  data-id="{{ item.id }}">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Message Analysis Panel -->
<div class="glass p-6 rounded-2xl">
  <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
    <i class="fas fa-magnifying-glass-chart text-neon-cyan"></i>
    {{ t['message_analysis'] }}
  </h2>
  <div id="analysisContent" class="min-h-[200px] flex items-center justify-center">
    <div class="text-center text-gray-500">
      <i class="fas fa-hand-pointer text-4xl mb-3 opacity-30"></i>
      <p>Хабарламаны таңдаңыз</p>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function () {
    // Analysis form submission
    $('#analysisForm').on('submit', function (e) {
      e.preventDefault();

      const text = $('#textInput').val().trim();
      const channel = $('#channelInput').val().trim();
      let date = $('#dateInput').val();

      if (!text) {
        Utils.showError('Мәтін енгізіңіз', 'Талдау үшін мәтін міндетті');
        return;
      }

      if (!date) {
        const now = new Date();
        date = now.toISOString().slice(0, 19);
      } else {
        date = date.replace('T', ' ') + ':00';
      }

      Utils.showLoading('{{ t["analyzing"] }}');

      $.ajax({
        url: '/analyze',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ text, channel, date }),
        success: function (data) {
          Utils.hideLoading();
          displayAnalysisResults(data);
          Utils.showSuccess('{{ t["analysis_complete"] }}');
          $('#textInput').val('');

          // Add to table (reload page for simplicity)
          setTimeout(() => location.reload(), 2000);
        },
        error: function (xhr) {
          Utils.hideLoading();
          Utils.showError(xhr.responseJSON?.detail || 'Талдау сәтсіз аяқталды');
        }
      });
    });

    // Display analysis results
    function displayAnalysisResults(data) {
      const analysis = data.analysis_report;
      const sentiment = analysis.general_sentiment;

      // IO Type
      $('#resIOType').text(analysis.predicted_info_operation_type || '—');

      // Fake Claim
      const fakeText = analysis.is_anomaly ? '{{ t["true"] }}' : '{{ t["false"] }}';
      const fakeClass = analysis.is_anomaly ? 'text-neon-red' : 'text-neon-green';
      $('#resFakeClaim').html(`<span class="${fakeClass} font-bold">${fakeText}</span>`);

      // Emotion
      const emoClass = sentiment.label.includes('POSITIVE') ? 'text-neon-green' : sentiment.label.includes('NEGATIVE') ? 'text-neon-red' : 'text-gray-400';
      $('#resEmotion').html(`<span class="${emoClass} font-bold">${sentiment.label}</span> <span class="text-xs text-gray-500">(${(sentiment.score * 100).toFixed(1)}%)</span>`);

      // Entities
      if (analysis.named_entities_recognition.length > 0) {
        const entities = analysis.named_entities_recognition.map(e =>
          `<span class="px-2 py-1 rounded-lg bg-neon-cyan/20 text-neon-cyan text-xs font-bold border border-neon-cyan/30">${e.word} <span class="opacity-50">(${e.entity})</span></span>`
        ).join(' ');
        $('#resEntities').html(entities);
      } else {
        $('#resEntities').html('<span class="text-gray-500 text-xs">Атаулар табылмады</span>');
      }

      // Terms
      if (analysis.military_terms_analysis.length > 0) {
        const terms = analysis.military_terms_analysis.map(t =>
          `<span class="px-2 py-1 rounded-lg bg-neon-green/20 text-neon-green text-xs font-bold border border-neon-green/30" title="${t.matched_alias}">${t.term_kz || t.term_ru || t.term_en}</span>`
        ).join(' ');
        $('#resTerms').html(terms);
      } else {
        $('#resTerms').html('<span class="text-gray-500 text-xs">Терминдер табылмады</span>');
      }

      // LLM Summary
      const llm = analysis.llm_expert_summary;
      $('#resSummary').text(llm.summary || 'LLM талдауы жоқ');

      // Threat Level
      const threat = llm.threat_level || 0;
      let threatColor = 'text-neon-green';
      let threatIcon = 'shield-halved';
      if (threat >= 4) {
        threatColor = 'text-neon-red';
        threatIcon = 'skull';
      } else if (threat === 3) {
        threatColor = 'text-yellow-500';
        threatIcon = 'triangle-exclamation';
      }

      $('#resThreat').html(`
                <div class="flex items-center gap-2 ${threatColor}">
                    <i class="fas fa-${threatIcon}"></i>
                    <span class="font-bold">Қауіп деңгейі: ${threat}/5</span>
                </div>
            `);

      // Show results
      $('#analysisResults').removeClass('hidden');
    }

    // Row click handler
    $('#messageTable tbody tr').on('click', function (e) {
      if ($(e.target).closest('.delete-btn').length) return;

      $('#messageTable tbody tr').removeClass('!bg-neon-purple/20');
      $(this).addClass('!bg-neon-purple/20');

      const data = {
        source: $(this).data('source'),
        date: $(this).data('date'),
        text: $(this).data('text'),
        io: $(this).data('io'),
        emo: $(this).data('emo'),
        fake: $(this).data('fake')
      };

      displayMessageAnalysis(data);
    });

    // Display message analysis
    function displayMessageAnalysis(data) {
      const fakeClass = data.fake === 'True' ? 'text-neon-red' : data.fake === 'False' ? 'text-neon-green' : 'text-gray-400';

      $('#analysisContent').html(`
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full">
                    <div class="glass p-4 rounded-xl">
                        <div class="text-xs text-gray-400 mb-1">Дереккөз</div>
                        <div class="font-bold">${data.source}</div>
                    </div>
                    <div class="glass p-4 rounded-xl">
                        <div class="text-xs text-gray-400 mb-1">Күні</div>
                        <div class="font-bold">${data.date}</div>
                    </div>
                    <div class="glass p-4 rounded-xl">
                        <div class="text-xs text-gray-400 mb-1">IO түрі</div>
                        <div class="font-bold text-neon-purple">${data.io}</div>
                    </div>
                    <div class="glass p-4 rounded-xl">
                        <div class="text-xs text-gray-400 mb-1">Эмоция</div>
                        <div class="font-bold">${data.emo}</div>
                    </div>
                    <div class="glass p-4 rounded-xl">
                        <div class="text-xs text-gray-400 mb-1">Фейк деректеме</div>
                        <div class="font-bold ${fakeClass}">${data.fake}</div>
                    </div>
                    <div class="glass p-4 rounded-xl col-span-1 md:col-span-3">
                        <div class="text-xs text-gray-400 mb-2">Мәтін</div>
                        <div class="text-sm leading-relaxed">${data.text}</div>
                    </div>
                </div>
            `);
    }

    // Delete button handler
    $('.delete-btn').on('click', function (e) {
      e.stopPropagation();
      const id = $(this).data('id');

      Swal.fire({
        title: '{{ t["confirm_delete"] }}?',
        text: 'Бұл әрекетті қайтару мүмкін емес',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#EF4444',
        cancelButtonColor: '#6B7280',
        confirmButtonText: '{{ t["yes"] }}, өшіру',
        cancelButtonText: '{{ t["cancel"] }}',
        background: '#1E293B',
        color: '#F1F5F9'
      }).then((result) => {
        if (result.isConfirmed) {
          $.post(`/delete/${id}`, () => location.reload());
        }
      });
    });
  });
</script>
{% endblock %}