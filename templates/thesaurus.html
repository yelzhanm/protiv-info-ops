{% extends "base.html" %}

{% block title %}{{ t['thesaurus'] }} - {{ t['app_title'] }}{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-8">
    <h1
        class="text-4xl font-display font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-neon-green to-neon-cyan">
        <i class="fas fa-book mr-3"></i>
        {{ t['military_thesaurus'] }}
    </h1>
    <p class="text-gray-400">”ò—Å–∫–µ—Ä–∏ —Ç–µ—Ä–º–∏–Ω–¥–µ—Ä –±–∞–∑–∞—Å—ã–Ω –±–∞—Å“õ–∞—Ä—É –∂”ô–Ω–µ ”©“£–¥–µ—É</p>
</div>

<!-- Main Grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

    <!-- Search Section -->
    <div class="lg:col-span-1">
        <div class="glass p-6 rounded-2xl sticky top-24 space-y-6">
            <!-- Search Form -->
            <div>
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-search text-neon-green"></i>
                    {{ t['search_term'] }}
                </h2>

                <form id="searchForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-300">{{ t['term'] }}</label>
                        <input type="text" id="searchTerm" list="existing-terms"
                            placeholder="Military operation, –î—Ä–æ–Ω, –ë–∞—Ä–ª–∞—É..."
                            class="w-full px-4 py-3 bg-space-light/50 border-2 border-neon-green/30 rounded-xl text-white placeholder-gray-500 focus:border-neon-green focus:shadow-neon-green focus:outline-none transition-all"
                            required>
                        <datalist id="existing-terms">
                            {% if all_terms %}
                            {% for term_name in all_terms %}
                            <option value="{{ term_name }}">
                                {% endfor %}
                                {% endif %}
                        </datalist>
                        <small class="text-gray-400 text-xs mt-1 block">–¢–µ—Ä–º–∏–Ω–¥—ñ –µ–Ω–≥—ñ–∑—ñ–ø, Enter –±–∞—Å—ã“£—ã–∑</small>
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-300">{{ t['language'] }}</label>
                        <select id="searchLanguage"
                            class="w-full px-4 py-3 bg-space-light/50 border-2 border-neon-green/30 rounded-xl text-white focus:border-neon-green focus:outline-none transition-all">
                            <option value="EN">üá¨üáß English (EN)</option>
                            <option value="RU">üá∑üá∫ –†—É—Å—Å–∫–∏–π (RU)</option>
                            <option value="KZ" selected>üá∞üáø “ö–∞–∑–∞“õ—à–∞ (KZ)</option>
                        </select>
                    </div>

                    <button type="submit"
                        class="w-full btn-glow py-3 rounded-xl font-bold bg-gradient-to-r from-neon-green to-neon-cyan hover:shadow-neon-green transition-all text-white flex items-center justify-center gap-2 group">
                        <i class="fas fa-search"></i>
                        <span>{{ t['search'] }}</span>
                        <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </form>
            </div>

            <!-- Stats -->
            <div class="pt-4 border-t border-neon-green/20">
                <h3 class="text-sm font-bold mb-3 text-gray-300 flex items-center gap-2">
                    <i class="fas fa-chart-simple"></i>
                    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                </h3>
                <div class="grid grid-cols-2 gap-3">
                    <div class="glass p-3 rounded-xl text-center border border-neon-green/20">
                        <div class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-neon-green to-green-400"
                            id="totalTerms">0</div>
                        <div class="text-xs text-gray-400 mt-1">–¢–µ—Ä–º–∏–Ω–¥–µ—Ä</div>
                    </div>
                    <div class="glass p-3 rounded-xl text-center border border-neon-cyan/20">
                        <div class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-neon-cyan to-blue-400"
                            id="totalRelations">0</div>
                        <div class="text-xs text-gray-400 mt-1">“ö–∞—Ç—ã–Ω–∞—Å—Ç–∞—Ä</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Term Section -->
    <div class="lg:col-span-2">
        <div class="glass p-6 rounded-2xl">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i class="fas fa-plus-circle text-neon-cyan"></i>
                {{ t['add_term'] }}
            </h2>

            <form id="addForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-300">{{ t['term_name'] }}</label>
                        <input type="text" id="newTerm" placeholder="–ñ–∞“£–∞ —Ç–µ—Ä–º–∏–Ω –∞—Ç–∞—É—ã"
                            class="w-full px-4 py-3 bg-space-light/50 border-2 border-neon-cyan/30 rounded-xl text-white placeholder-gray-500 focus:border-neon-cyan focus:shadow-neon-cyan focus:outline-none transition-all"
                            required>
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-300">{{ t['language'] }}</label>
                        <select id="newLanguage"
                            class="w-full px-4 py-3 bg-space-light/50 border-2 border-neon-cyan/30 rounded-xl text-white focus:border-neon-cyan focus:outline-none transition-all">
                            <option value="EN">üá¨üáß English (EN)</option>
                            <option value="RU">üá∑üá∫ –†—É—Å—Å–∫–∏–π (RU)</option>
                            <option value="KZ">üá∞üáø “ö–∞–∑–∞“õ—à–∞ (KZ)</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold mb-2 text-gray-300">{{ t['scope_note'] }} (–û–ø—Ü–∏–æ–Ω–∞–ª–¥—ã)</label>
                    <textarea id="scopeNote" rows="3" placeholder="–¢–µ—Ä–º–∏–Ω–Ω—ñ“£ —Å–∏–ø–∞—Ç—Ç–∞–º–∞—Å—ã –Ω–µ–º–µ—Å–µ –∞–Ω—ã“õ—Ç–∞–º–∞—Å—ã..."
                        class="w-full px-4 py-3 bg-space-light/50 border-2 border-neon-cyan/30 rounded-xl text-white placeholder-gray-500 focus:border-neon-cyan focus:shadow-neon-cyan focus:outline-none transition-all resize-none"></textarea>
                </div>

                <!-- Relationship Options -->
                <div class="glass p-4 rounded-xl border border-neon-purple/20">
                    <h3 class="text-sm font-bold mb-3 text-neon-purple flex items-center gap-2">
                        <i class="fas fa-link"></i>
                        “ö–∞—Ç—ã–Ω–∞—Å “õ–æ—Å—É (–û–ø—Ü–∏–æ–Ω–∞–ª–¥—ã)
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold mb-2 text-gray-400">“ö–∞—Ç—ã–Ω–∞—Å —Ç“Ø—Ä—ñ</label>
                            <select id="relationType"
                                class="w-full px-3 py-2 text-sm bg-space-light/50 border border-neon-purple/30 rounded-lg text-white focus:border-neon-purple focus:outline-none transition-all">
                                <option value="">-- –¢–∞“£–¥–∞“£—ã–∑ --</option>
                                <option value="BT">BT - Broader Term (–ö–µ“£—ñ—Ä–µ–∫ —Ç–µ—Ä–º–∏–Ω)</option>
                                <option value="NT">NT - Narrower Term (–¢–∞—Ä—ã—Ä–∞“õ —Ç–µ—Ä–º–∏–Ω)</option>
                                <option value="RT">RT - Related Term (–ë–∞–π–ª–∞–Ω—ã—Å—Ç—ã)</option>
                                <option value="UF">UF - Used For (–°–∏–Ω–æ–Ω–∏–º)</option>
                                <option value="PT">PT - Part Of (–ë”©–ª—ñ–≥—ñ)</option>
                                <option value="LE">LE - Language Equivalent (–≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç)</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-bold mb-2 text-gray-400">–ë–∞–π–ª–∞–Ω—ã—Å—Ç—ã —Ç–µ—Ä–º–∏–Ω</label>
                            <input type="text" id="relatedTerm" list="existing-terms-add"
                                placeholder="–ë–∞—Ä —Ç–µ—Ä–º–∏–Ω–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑..."
                                class="w-full px-3 py-2 text-sm bg-space-light/50 border border-neon-purple/30 rounded-lg text-white focus:border-neon-purple focus:outline-none transition-all">
                            <datalist id="existing-terms-add">
                                {% if all_terms %}
                                {% for term_name in all_terms %}
                                <option value="{{ term_name }}">
                                    {% endfor %}
                                    {% endif %}
                            </datalist>
                        </div>
                    </div>

                    <!-- Help Info -->
                    <div class="mt-3 p-3 rounded-lg bg-blue-500/10 border border-blue-500/20">
                        <div class="flex items-start gap-2">
                            <i class="fas fa-circle-info text-blue-400 mt-0.5"></i>
                            <div class="text-xs text-gray-400">
                                <div class="font-bold text-blue-400 mb-1">“ö–∞—Ç—ã–Ω–∞—Å —Ç“Ø—Ä–ª–µ—Ä—ñ:</div>
                                <div class="space-y-0.5">
                                    <div><strong>BT:</strong> –ë“±–ª —Ç–µ—Ä–º–∏–Ω –Ω–µ“ì“±—Ä–ª—ã–º –Ω–∞“õ—Ç—ã</div>
                                    <div><strong>NT:</strong> –ë“±–ª —Ç–µ—Ä–º–∏–Ω –Ω–µ“ì“±—Ä–ª—ã–º –∂–∞–ª–ø—ã</div>
                                    <div><strong>RT:</strong> –ö–æ–Ω—Ü–µ–ø—Ç—É–∞–ª–¥—ã –±–∞–π–ª–∞–Ω—ã—Å—Ç—ã</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit"
                    class="w-full btn-glow py-3 rounded-xl font-bold bg-gradient-to-r from-neon-cyan to-neon-purple hover:shadow-neon-cyan transition-all text-white flex items-center justify-center gap-2 group">
                    <i class="fas fa-plus"></i>
                    <span>{{ t['add'] }} –¢–µ—Ä–º–∏–Ω</span>
                    <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Search Results -->
<div id="resultsSection" class="hidden">
    <div class="glass p-6 rounded-2xl">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold flex items-center gap-2">
                <i class="fas fa-list-check text-neon-green"></i>
                –Ü–∑–¥–µ—É –Ω”ô—Ç–∏–∂–µ–ª–µ—Ä—ñ
            </h2>
            <button onclick="$('#resultsSection').addClass('hidden')"
                class="px-3 py-1 rounded-lg bg-neon-red/20 hover:bg-neon-red/30 text-neon-red transition-colors text-sm">
                <i class="fas fa-times"></i> –ñ–∞–±—É
            </button>
        </div>

        <!-- Language Tabs -->
        <div id="languageTabs" class="flex gap-2 mb-6 border-b border-neon-green/20 pb-2"></div>

        <!-- Language Content -->
        <div id="languageContent"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        loadStats();

        // Search form
        $('#searchForm').on('submit', function (e) {
            e.preventDefault();
            searchTerm();
        });

        // Add form
        $('#addForm').on('submit', function (e) {
            e.preventDefault();
            addTerm();
        });
    });

    function loadStats() {
        Utils.animateNumber('totalTerms', {{ all_terms| length if all_terms else 0
    }}, 1000);
    Utils.animateNumber('totalRelations', 450, 1000);
    }

    function searchTerm() {
        const term = $('#searchTerm').val().trim();
        const language = $('#searchLanguage').val();

        if (!term) {
            Utils.showError('–¢–µ—Ä–º–∏–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑', '–Ü–∑–¥–µ—É “Ø—à—ñ–Ω —Ç–µ—Ä–º–∏–Ω –º—ñ–Ω–¥–µ—Ç—Ç—ñ');
            return;
        }

        Utils.showLoading('–Ü–∑–¥–µ—É –∂“Ø—Ä–≥—ñ–∑—ñ–ª—É–¥–µ...');

        $.ajax({
            url: `/thesaurus/search?term=${encodeURIComponent(term)}&language=${language}`,
            method: 'GET',
            success: function (data) {
                Utils.hideLoading();
                displayResults(data);
            },
            error: function (xhr) {
                Utils.hideLoading();
                Utils.showError(xhr.responseJSON?.error || '–¢–µ—Ä–º–∏–Ω —Ç–∞–±—ã–ª–º–∞–¥—ã');
            }
        });
    }

    function displayResults(data) {
        if (!data.results || Object.keys(data.results).length === 0) {
            Utils.showError('–ù”ô—Ç–∏–∂–µ —Ç–∞–±—ã–ª–º–∞–¥—ã', '–ë–∞—Å“õ–∞ —Ç–µ—Ä–º–∏–Ω –Ω–µ–º–µ—Å–µ —Ç—ñ–ª–¥—ñ “õ–æ–ª–¥–∞–Ω—ã–ø –∫”©—Ä—ñ“£—ñ–∑');
            return;
        }

        const languages = Object.keys(data.results);
        let tabsHTML = '';
        let contentHTML = '';

        languages.forEach((lang, index) => {
            const langData = data.results[lang];
            const isActive = index === 0;

            // Tab
            tabsHTML += `
                <button class="px-4 py-2 rounded-lg font-bold transition-all ${isActive ? 'bg-gradient-to-r from-neon-green to-neon-cyan text-white shadow-neon-green' : 'bg-space-light/30 text-gray-400 hover:text-white'}" 
                        data-lang="${lang}" 
                        onclick="switchLanguageTab('${lang}')">
                    ${langData.term} (${lang})
                </button>
            `;

            // Content
            contentHTML += `
                <div class="language-content ${isActive ? '' : 'hidden'}" data-lang="${lang}">
                    <!-- Header -->
                    <div class="mb-6 p-6 rounded-xl bg-gradient-to-r from-neon-green/20 to-neon-cyan/20 border border-neon-green/30">
                        <div class="text-3xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-neon-green to-neon-cyan">
                            ${langData.term}
                        </div>
                        <span class="px-3 py-1 rounded-full bg-neon-green/20 text-neon-green text-sm font-bold border border-neon-green/30">
                            ${lang}
                        </span>
                    </div>

                    ${langData.scope_notes && langData.scope_notes.length > 0 ? `
                        <div class="mb-6 p-4 rounded-xl bg-blue-500/10 border border-blue-500/20">
                            <h3 class="text-sm font-bold mb-2 text-blue-400 flex items-center gap-2">
                                <i class="fas fa-info-circle"></i>
                                –ê–Ω—ã“õ—Ç–∞–º–∞
                            </h3>
                            ${langData.scope_notes.map(note => note ? `<p class="text-sm text-gray-400">${note}</p>` : '').join('')}
                        </div>
                    ` : ''}

                    <!-- Relations -->
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i class="fas fa-project-diagram text-neon-purple"></i>
                        “ö–∞—Ç—ã–Ω–∞—Å—Ç–∞—Ä
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${createRelationCard('BROADER_TERM', '–ö–µ“£—ñ—Ä–µ–∫ —Ç–µ—Ä–º–∏–Ω–¥–µ—Ä', 'sitemap', langData.relations?.BROADER_TERM)}
                        ${createRelationCard('NARROWER_TERM', '–¢–∞—Ä—ã—Ä–∞“õ —Ç–µ—Ä–º–∏–Ω–¥–µ—Ä', 'diagram-project', langData.relations?.NARROWER_TERM)}
                        ${createRelationCard('RELATED_TERM', '–ë–∞–π–ª–∞–Ω—ã—Å—Ç—ã', 'link', langData.relations?.RELATED_TERM)}
                        ${createRelationCard('USED_FOR', '–°–∏–Ω–æ–Ω–∏–º–¥–µ—Ä', 'repeat', langData.relations?.USED_FOR)}
                        ${createRelationCard('PART_OF', '–ë”©–ª—ñ–≥—ñ', 'puzzle-piece', langData.relations?.PART_OF)}
                        ${createRelationCard('LANGUAGE_EQUIVALENT', '–≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç—Ç–µ—Ä', 'language', langData.relations?.LANGUAGE_EQUIVALENT)}
                    </div>
                </div>
            `;
        });

        $('#languageTabs').html(tabsHTML);
        $('#languageContent').html(contentHTML);
        $('#resultsSection').removeClass('hidden');

        // Scroll to results
        $('html, body').animate({
            scrollTop: $('#resultsSection').offset().top - 100
        }, 400);
    }

    function switchLanguageTab(lang) {
        $('.language-content').addClass('hidden');
        $(`.language-content[data-lang="${lang}"]`).removeClass('hidden');

        $('#languageTabs button').removeClass('bg-gradient-to-r from-neon-green to-neon-cyan text-white shadow-neon-green')
            .addClass('bg-space-light/30 text-gray-400');
        $(`#languageTabs button[data-lang="${lang}"]`).removeClass('bg-space-light/30 text-gray-400')
            .addClass('bg-gradient-to-r from-neon-green to-neon-cyan text-white shadow-neon-green');
    }

    function createRelationCard(type, title, icon, relations) {
        if (!relations || relations.length === 0 || !relations[0]?.term) {
            return `
                <div class="glass p-4 rounded-xl border border-neon-purple/20">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-neon-purple/20 to-neon-purple/10 flex items-center justify-center">
                            <i class="fas fa-${icon} text-neon-purple text-sm"></i>
                        </div>
                        <h4 class="font-bold text-sm">${title}</h4>
                    </div>
                    <p class="text-xs text-gray-500 text-center py-2">–ñ–æ“õ</p>
                </div>
            `;
        }

        const items = relations.map(rel => {
            if (!rel.term) return '';
            return `
                <div class="flex items-center justify-between p-2 rounded-lg bg-space-light/30 hover:bg-neon-purple/10 transition-colors cursor-pointer group">
                    <span class="text-sm">${rel.term}</span>
                    <span class="px-2 py-0.5 rounded bg-neon-purple/20 text-neon-purple text-xs font-bold border border-neon-purple/30">${rel.language || '?'}</span>
                </div>
            `;
        }).join('');

        return `
            <div class="glass p-4 rounded-xl border border-neon-purple/20">
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-neon-purple to-purple-600 flex items-center justify-center">
                        <i class="fas fa-${icon} text-white text-sm"></i>
                    </div>
                    <h4 class="font-bold text-sm">${title}</h4>
                </div>
                <div class="space-y-2">${items}</div>
            </div>
        `;
    }

    function addTerm() {
        const formData = {
            term: $('#newTerm').val().trim(),
            language: $('#newLanguage').val(),
            scope_note: $('#scopeNote').val().trim(),
            relation_type: $('#relationType').val(),
            related_term: $('#relatedTerm').val().trim()
        };

        if (!formData.term) {
            Utils.showError('–¢–µ—Ä–º–∏–Ω –∞—Ç–∞—É—ã “õ–∞–∂–µ—Ç', '–¢–µ—Ä–º–∏–Ω –∞—Ç–∞—É—ã–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑');
            return;
        }

        Utils.showLoading('–¢–µ—Ä–º–∏–Ω “õ–æ—Å—ã–ª—É–¥–∞...');

        const fd = new FormData();
        Object.keys(formData).forEach(key => {
            if (formData[key]) fd.append(key, formData[key]);
        });

        $.ajax({
            url: '/thesaurus/add',
            method: 'POST',
            data: fd,
            processData: false,
            contentType: false,
            success: function (data) {
                Utils.hideLoading();
                Utils.showSuccess(data.success || '–¢–µ—Ä–º–∏–Ω “õ–æ—Å—ã–ª–¥—ã');
                $('#addForm')[0].reset();
                loadStats();
            },
            error: function (xhr) {
                Utils.hideLoading();
                Utils.showError(xhr.responseJSON?.error || '–¢–µ—Ä–º–∏–Ω “õ–æ—Å—ã–ª–º–∞–¥—ã');
            }
        });
    }
</script>
{% endblock %}