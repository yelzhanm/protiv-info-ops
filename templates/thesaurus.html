{% extends "base.html" %}

{% block title %}{{ t.thesaurus }} - {{ t.app_title }}{% endblock %}

{% block extra_css %}
<style>
    .thesaurus-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .thesaurus-grid-full {
        grid-column: 1 / -1;
    }

    /* Search Section */
    .search-section {
        position: sticky;
        top: 20px;
    }

    .search-form-group {
        margin-bottom: 1rem;
    }

    .datalist-wrapper {
        position: relative;
    }

    .datalist-wrapper input {
        width: 100%;
    }

    /* Results Section */
    .results-section {
        display: none;
        animation: fadeIn 0.4s ease;
    }

    .results-section.show {
        display: block;
    }

    .language-tab-list {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid var(--border);
        padding-bottom: 0;
    }

    .language-tab {
        padding: 0.8rem 1.5rem;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        color: var(--text-muted);
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .language-tab:hover {
        color: var(--primary);
    }

    .language-tab.active {
        color: var(--success);
        border-bottom-color: var(--success);
    }

    .language-content {
        display: none;
        animation: fadeIn 0.3s ease;
    }

    .language-content.active {
        display: block;
    }

    .term-header {
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        color: white;
        padding: 1.5rem;
        border-radius: 12px 12px 0 0;
        margin: -1.5rem -1.5rem 1.5rem -1.5rem;
    }

    .term-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .term-language-badge {
        display: inline-block;
        padding: 4px 12px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        font-size: 0.9rem;
    }

    /* Scope Notes */
    .scope-notes-box {
        background: var(--success-light);
        border-left: 4px solid var(--success);
        padding: 1.2rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }

    .scope-notes-box h6 {
        color: var(--success-dark);
        margin-bottom: 0.8rem;
        font-weight: 600;
    }

    .scope-note-item {
        background: white;
        padding: 0.8rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        line-height: 1.6;
    }

    /* Relations Grid */
    .relations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .relation-card {
        background: var(--bg-main);
        border: 2px solid var(--border);
        border-radius: 10px;
        padding: 1.2rem;
        transition: all 0.3s;
    }

    .relation-card:hover {
        border-color: var(--success);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
        transform: translateY(-2px);
    }

    .relation-type-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 1rem;
        padding-bottom: 0.8rem;
        border-bottom: 2px solid var(--border);
    }

    .relation-type-icon {
        width: 32px;
        height: 32px;
        background: var(--success);
        color: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
    }

    .relation-type-title {
        font-weight: 600;
        color: var(--primary);
        font-size: 0.95rem;
    }

    .relation-items {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .relation-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.6rem 0.8rem;
        margin-bottom: 0.5rem;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .relation-item:hover {
        background: var(--success-light);
        transform: translateX(5px);
    }

    .relation-term-name {
        flex: 1;
        color: var(--text-main);
        font-weight: 500;
    }

    .relation-lang-badge {
        padding: 3px 10px;
        background: var(--primary);
        color: white;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .empty-relations {
        text-align: center;
        padding: 1.5rem;
        color: var(--text-muted);
        font-style: italic;
    }

    /* Add Form Section */
    .relationship-options {
        background: var(--bg-main);
        border-radius: 10px;
        padding: 1.2rem;
        margin-top: 1rem;
    }

    .relationship-options h6 {
        color: var(--primary);
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .relationship-help {
        background: #e0f2fe;
        border-left: 4px solid #0ea5e9;
        padding: 1rem;
        border-radius: 6px;
        margin-top: 1rem;
    }

    .relationship-help-title {
        color: #0369a1;
        font-weight: 600;
        margin-bottom: 0.8rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .relationship-help ul {
        margin: 0;
        padding-left: 1.2rem;
    }

    .relationship-help li {
        margin-bottom: 0.5rem;
        line-height: 1.5;
    }

    .relationship-help strong {
        color: #0369a1;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--text-muted);
    }

    .empty-state i {
        font-size: 4rem;
        opacity: 0.2;
        margin-bottom: 1rem;
    }

    .empty-state h5 {
        margin-bottom: 0.5rem;
    }

    /* Loading */
    .loading-inline {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid var(--border);
        border-top-color: var(--success);
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        margin-left: 8px;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .thesaurus-grid {
            grid-template-columns: 1fr;
        }

        .search-section {
            position: static;
        }
    }

    @media (max-width: 768px) {
        .relations-grid {
            grid-template-columns: 1fr;
        }

        .language-tab-list {
            overflow-x: auto;
            flex-wrap: nowrap;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="mb-4">
        <h1 class="h3 mb-1">
            <i class="fas fa-book"></i>
            {{ t.military_thesaurus }}
        </h1>
        <p class="text-muted">”ò—Å–∫–µ—Ä–∏ —Ç–µ—Ä–º–∏–Ω–¥–µ—Ä –±–∞–∑–∞—Å—ã–Ω –±–∞—Å“õ–∞—Ä—É –∂”ô–Ω–µ ”©“£–¥–µ—É</p>
    </div>

    <div class="thesaurus-grid">
        <!-- Search Section (Left) -->
        <div class="search-section">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-search"></i>
                    {{ t.search_term }}
                </div>
                <div class="card-body">
                    <form id="searchForm">
                        <div class="search-form-group">
                            <label for="searchTerm" class="form-label">{{ t.term }}</label>
                            <div class="datalist-wrapper">
                                <input type="text" class="form-control" id="searchTerm" name="term"
                                    list="existing-terms" placeholder="Military operation, –î—Ä–æ–Ω, –ë–∞—Ä–ª–∞—É..." required>
                                <datalist id="existing-terms">
                                    {% if all_terms %}
                                    {% for term_name in all_terms %}
                                    <option value="{{ term_name }}">
                                        {% endfor %}
                                        {% endif %}
                                </datalist>
                            </div>
                            <small class="text-muted">–¢–µ—Ä–º–∏–Ω–¥—ñ –µ–Ω–≥—ñ–∑—ñ–ø, Enter –±–∞—Å—ã“£—ã–∑</small>
                        </div>

                        <div class="search-form-group">
                            <label for="searchLanguage" class="form-label">{{ t.language }}</label>
                            <select class="form-select" id="searchLanguage" name="language">
                                <option value="EN">üá¨üáß English (EN)</option>
                                <option value="RU">üá∑üá∫ –†—É—Å—Å–∫–∏–π (RU)</option>
                                <option value="KZ" selected>üá∞üáø “ö–∞–∑–∞“õ—à–∞ (KZ)</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-search"></i>
                            {{ t.search }}
                        </button>
                    </form>

                    <!-- Quick Stats -->
                    <div class="mt-4 pt-3 border-top">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-chart-simple"></i>
                            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                        </h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="text-center p-2 bg-light rounded">
                                    <div class="h5 mb-0 text-success" id="totalTerms">0</div>
                                    <small class="text-muted">–¢–µ—Ä–º–∏–Ω–¥–µ—Ä</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 bg-light rounded">
                                    <div class="h5 mb-0 text-primary" id="totalRelations">0</div>
                                    <small class="text-muted">“ö–∞—Ç—ã–Ω–∞—Å—Ç–∞—Ä</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Term Section (Right) -->
        <div>
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-plus-circle"></i>
                    {{ t.add_term }}
                </div>
                <div class="card-body">
                    <form id="addForm">
                        <div class="mb-3">
                            <label for="newTerm" class="form-label">{{ t.term_name }}</label>
                            <input type="text" class="form-control" id="newTerm" name="term"
                                placeholder="–ñ–∞“£–∞ —Ç–µ—Ä–º–∏–Ω –∞—Ç–∞—É—ã" required>
                        </div>

                        <div class="mb-3">
                            <label for="newLanguage" class="form-label">{{ t.language }}</label>
                            <select class="form-select" id="newLanguage" name="language">
                                <option value="EN">üá¨üáß English (EN)</option>
                                <option value="RU">üá∑üá∫ –†—É—Å—Å–∫–∏–π (RU)</option>
                                <option value="KZ">üá∞üáø “ö–∞–∑–∞“õ—à–∞ (KZ)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="scopeNote" class="form-label">{{ t.scope_note }} (–û–ø—Ü–∏–æ–Ω–∞–ª–¥—ã)</label>
                            <textarea class="form-control" id="scopeNote" name="scope_note" rows="3"
                                placeholder="–¢–µ—Ä–º–∏–Ω–Ω—ñ“£ —Å–∏–ø–∞—Ç—Ç–∞–º–∞—Å—ã –Ω–µ–º–µ—Å–µ –∞–Ω—ã“õ—Ç–∞–º–∞—Å—ã..."></textarea>
                        </div>

                        <!-- Relationship Options -->
                        <div class="relationship-options">
                            <h6>
                                <i class="fas fa-link"></i>
                                “ö–∞—Ç—ã–Ω–∞—Å “õ–æ—Å—É (–û–ø—Ü–∏–æ–Ω–∞–ª–¥—ã)
                            </h6>

                            <div class="mb-3">
                                <label for="relationType" class="form-label">“ö–∞—Ç—ã–Ω–∞—Å —Ç“Ø—Ä—ñ</label>
                                <select class="form-select" id="relationType" name="relation_type">
                                    <option value="">-- –¢–∞“£–¥–∞“£—ã–∑ --</option>
                                    <option value="BT">BT - Broader Term (–ö–µ“£—ñ—Ä–µ–∫ —Ç–µ—Ä–º–∏–Ω)</option>
                                    <option value="NT">NT - Narrower Term (–¢–∞—Ä—ã—Ä–∞“õ —Ç–µ—Ä–º–∏–Ω)</option>
                                    <option value="RT">RT - Related Term (–ë–∞–π–ª–∞–Ω—ã—Å—Ç—ã —Ç–µ—Ä–º–∏–Ω)</option>
                                    <option value="UF">UF - Used For (–°–∏–Ω–æ–Ω–∏–º)</option>
                                    <option value="PT">PT - Part Of (–ë”©–ª—ñ–≥—ñ)</option>
                                    <option value="LE">LE - Language Equivalent (–¢—ñ–ª–¥—ñ–∫ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç)</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="relatedTerm" class="form-label">–ë–∞–π–ª–∞–Ω—ã—Å—Ç—ã —Ç–µ—Ä–º–∏–Ω</label>
                                <input type="text" class="form-control" id="relatedTerm" name="related_term"
                                    list="existing-terms-add" placeholder="–ë–∞—Ä —Ç–µ—Ä–º–∏–Ω–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑...">
                                <datalist id="existing-terms-add">
                                    {% if all_terms %}
                                    {% for term_name in all_terms %}
                                    <option value="{{ term_name }}">
                                        {% endfor %}
                                        {% endif %}
                                </datalist>
                                <small class="text-muted">–§–æ—Ä–º–∞—Ç: "—Ç–µ—Ä–º–∏–Ω (—Ç—ñ–ª)" –Ω–µ–º–µ—Å–µ "—Ç–µ—Ä–º–∏–Ω"</small>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-plus"></i>
                            {{ t.add }} –¢–µ—Ä–º–∏–Ω
                        </button>
                    </form>

                    <!-- Relationship Help -->
                    <div class="relationship-help">
                        <div class="relationship-help-title">
                            <i class="fas fa-circle-info"></i>
                            “ö–∞—Ç—ã–Ω–∞—Å —Ç“Ø—Ä–ª–µ—Ä—ñ
                        </div>
                        <ul>
                            <li><strong>BT:</strong> –ë“±–ª —Ç–µ—Ä–º–∏–Ω –Ω–µ“ì“±—Ä–ª—ã–º –Ω–∞“õ—Ç—ã</li>
                            <li><strong>NT:</strong> –ë“±–ª —Ç–µ—Ä–º–∏–Ω –Ω–µ“ì“±—Ä–ª—ã–º –∂–∞–ª–ø—ã</li>
                            <li><strong>RT:</strong> –ö–æ–Ω—Ü–µ–ø—Ç—É–∞–ª–¥—ã –±–∞–π–ª–∞–Ω—ã—Å—Ç—ã</li>
                            <li><strong>UF:</strong> –°–∏–Ω–æ–Ω–∏–º –Ω–µ–º–µ—Å–µ –±–∞–ª–∞–º–∞–ª—ã –∞—Ç–∞—É</li>
                            <li><strong>PT:</strong> “Æ–ª–∫–µ–Ω —Ç–µ—Ä–º–∏–Ω–Ω—ñ“£ –±”©–ª—ñ–≥—ñ</li>
                            <li><strong>LE:</strong> –ë–∞—Å“õ–∞ —Ç—ñ–ª–¥–µ–≥—ñ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section (Full Width) -->
        <div class="thesaurus-grid-full">
            <div id="resultsSection" class="results-section">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-list-check"></i>
                        –Ü–∑–¥–µ—É –Ω”ô—Ç–∏–∂–µ–ª–µ—Ä—ñ
                    </div>
                    <div class="card-body">
                        <!-- Language Tabs -->
                        <div class="language-tab-list" id="languageTabs">
                            <!-- Populated by JS -->
                        </div>

                        <!-- Language Content -->
                        <div id="languageContent">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        // Load stats
        loadStats();

        // Search form
        $('#searchForm').on('submit', function (e) {
            e.preventDefault();
            searchTerm();
        });

        // Add form
        $('#addForm').on('submit', function (e) {
            e.preventDefault();
            addTerm();
        });
    });

    // Load statistics
    function loadStats() {
        // Mock data - –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ API call
        animateNumber('totalTerms', {{ all_terms| length if all_terms else 0
    }});
    animateNumber('totalRelations', 450);
    }

    // Animate number
    function animateNumber(elementId, target) {
        const element = document.getElementById(elementId);
        let current = 0;
        const increment = target / 30;
        const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
                element.textContent = Math.round(target);
                clearInterval(timer);
            } else {
                element.textContent = Math.round(current);
            }
        }, 30);
    }

    // Search term
    function searchTerm() {
        const term = $('#searchTerm').val().trim();
        const language = $('#searchLanguage').val();

        if (!term) {
            Swal.fire({
                icon: 'warning',
                title: '–¢–µ—Ä–º–∏–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑',
                text: '–Ü–∑–¥–µ—É “Ø—à—ñ–Ω —Ç–µ—Ä–º–∏–Ω –º—ñ–Ω–¥–µ—Ç—Ç—ñ'
            });
            return;
        }

        // Show loading
        const btn = $('#searchForm button[type="submit"]');
        const btnText = btn.html();
        btn.html('<span class="spinner-border spinner-border-sm"></span> –Ü–∑–¥–µ—É...').prop('disabled', true);

        $.ajax({
            url: `/thesaurus/search?term=${encodeURIComponent(term)}&language=${language}`,
            method: 'GET',
            success: function (data) {
                btn.html(btnText).prop('disabled', false);
                displayResults(data);
            },
            error: function (xhr) {
                btn.html(btnText).prop('disabled', false);
                const error = xhr.responseJSON?.error || '–¢–µ—Ä–º–∏–Ω —Ç–∞–±—ã–ª–º–∞–¥—ã';
                Swal.fire({
                    icon: 'error',
                    title: '“ö–∞—Ç–µ',
                    text: error
                });
            }
        });
    }

    // Display search results
    function displayResults(data) {
        if (!data.results || Object.keys(data.results).length === 0) {
            $('#resultsSection').html(`
                <div class="card">
                    <div class="card-body">
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <h5>–ù”ô—Ç–∏–∂–µ —Ç–∞–±—ã–ª–º–∞–¥—ã</h5>
                            <p>–ë–∞—Å“õ–∞ —Ç–µ—Ä–º–∏–Ω –Ω–µ–º–µ—Å–µ —Ç—ñ–ª–¥—ñ “õ–æ–ª–¥–∞–Ω—ã–ø –∫”©—Ä—ñ“£—ñ–∑</p>
                        </div>
                    </div>
                </div>
            `);
            $('#resultsSection').addClass('show');
            return;
        }

        // Create language tabs
        const languages = Object.keys(data.results);
        let tabsHTML = '';
        let contentHTML = '';

        languages.forEach((lang, index) => {
            const langData = data.results[lang];
            const isActive = index === 0 ? 'active' : '';

            // Tab
            tabsHTML += `
                <button class="language-tab ${isActive}" data-lang="${lang}">
                    ${langData.term} (${lang})
                </button>
            `;

            // Content
            contentHTML += `
                <div class="language-content ${isActive}" data-lang="${lang}">
                    <div class="term-header">
                        <div class="term-title">${langData.term}</div>
                        <span class="term-language-badge">${lang}</span>
                    </div>

                    ${langData.scope_notes && langData.scope_notes.length > 0 ? `
                        <div class="scope-notes-box">
                            <h6><i class="fas fa-info-circle"></i> –ê–Ω—ã“õ—Ç–∞–º–∞</h6>
                            ${langData.scope_notes.map(note => note ? `<div class="scope-note-item">${note}</div>` : '').join('')}
                        </div>
                    ` : ''}

                    <h6 class="mb-3"><i class="fas fa-project-diagram"></i> “ö–∞—Ç—ã–Ω–∞—Å—Ç–∞—Ä</h6>
                    <div class="relations-grid">
                        ${createRelationCard('BROADER_TERM', '–ö–µ“£—ñ—Ä–µ–∫ —Ç–µ—Ä–º–∏–Ω–¥–µ—Ä', 'sitemap', langData.relations?.BROADER_TERM)}
                        ${createRelationCard('NARROWER_TERM', '–¢–∞—Ä—ã—Ä–∞“õ —Ç–µ—Ä–º–∏–Ω–¥–µ—Ä', 'diagram-project', langData.relations?.NARROWER_TERM)}
                        ${createRelationCard('RELATED_TERM', '–ë–∞–π–ª–∞–Ω—ã—Å—Ç—ã —Ç–µ—Ä–º–∏–Ω–¥–µ—Ä', 'link', langData.relations?.RELATED_TERM)}
                        ${createRelationCard('USED_FOR', '–°–∏–Ω–æ–Ω–∏–º–¥–µ—Ä', 'repeat', langData.relations?.USED_FOR)}
                        ${createRelationCard('PART_OF', '–ë”©–ª—ñ–≥—ñ', 'puzzle-piece', langData.relations?.PART_OF)}
                        ${createRelationCard('LANGUAGE_EQUIVALENT', '–¢—ñ–ª–¥—ñ–∫ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç—Ç–µ—Ä', 'language', langData.relations?.LANGUAGE_EQUIVALENT)}
                    </div>
                </div>
            `;
        });

        $('#languageTabs').html(tabsHTML);
        $('#languageContent').html(contentHTML);
        $('#resultsSection').addClass('show');

        // Tab click handlers
        $('.language-tab').on('click', function () {
            const lang = $(this).data('lang');
            $('.language-tab').removeClass('active');
            $(this).addClass('active');
            $('.language-content').removeClass('active');
            $(`.language-content[data-lang="${lang}"]`).addClass('active');
        });

        // Relation item click (search related term)
        $('.relation-item').on('click', function () {
            const term = $(this).data('term');
            const lang = $(this).data('lang');
            if (term && lang) {
                $('#searchTerm').val(term);
                $('#searchLanguage').val(lang);
                searchTerm();
                $('html, body').animate({ scrollTop: 0 }, 400);
            }
        });
    }

    // Create relation card HTML
    function createRelationCard(type, title, icon, relations) {
        if (!relations || relations.length === 0 || !relations[0]?.term) {
            return `
                <div class="relation-card">
                    <div class="relation-type-header">
                        <div class="relation-type-icon">
                            <i class="fas fa-${icon}"></i>
                        </div>
                        <div class="relation-type-title">${title}</div>
                    </div>
                    <div class="empty-relations">–ñ–æ“õ</div>
                </div>
            `;
        }

        const items = relations.map(rel => {
            if (!rel.term) return '';
            return `
                <li class="relation-item" data-term="${rel.term}" data-lang="${rel.language}">
                    <span class="relation-term-name">${rel.term}</span>
                    <span class="relation-lang-badge">${rel.language || '?'}</span>
                </li>
            `;
        }).join('');

        return `
            <div class="relation-card">
                <div class="relation-type-header">
                    <div class="relation-type-icon">
                        <i class="fas fa-${icon}"></i>
                    </div>
                    <div class="relation-type-title">${title}</div>
                </div>
                <ul class="relation-items">
                    ${items}
                </ul>
            </div>
        `;
    }

    // Add new term
    function addTerm() {
        const formData = {
            term: $('#newTerm').val().trim(),
            language: $('#newLanguage').val(),
            scope_note: $('#scopeNote').val().trim(),
            relation_type: $('#relationType').val(),
            related_term: $('#relatedTerm').val().trim()
        };

        if (!formData.term) {
            Swal.fire({
                icon: 'warning',
                title: '–¢–µ—Ä–º–∏–Ω –∞—Ç–∞—É—ã “õ–∞–∂–µ—Ç',
                text: '–¢–µ—Ä–º–∏–Ω –∞—Ç–∞—É—ã–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑'
            });
            return;
        }

        // Show loading
        const btn = $('#addForm button[type="submit"]');
        const btnText = btn.html();
        btn.html('<span class="spinner-border spinner-border-sm"></span> “ö–æ—Å—ã–ª—É–¥–∞...').prop('disabled', true);

        // Convert to FormData for backend
        const fd = new FormData();
        Object.keys(formData).forEach(key => {
            if (formData[key]) fd.append(key, formData[key]);
        });

        $.ajax({
            url: '/thesaurus/add',
            method: 'POST',
            data: fd,
            processData: false,
            contentType: false,
            success: function (data) {
                btn.html(btnText).prop('disabled', false);

                Swal.fire({
                    icon: 'success',
                    title: '–°”ô—Ç—Ç—ñ!',
                    text: data.success || '–¢–µ—Ä–º–∏–Ω “õ–æ—Å—ã–ª–¥—ã',
                    timer: 2000,
                    showConfirmButton: false
                });

                // Clear form
                $('#addForm')[0].reset();

                // Reload stats
                loadStats();

                // Update datalists if needed
                if (data.all_terms) {
                    updateDatalist(data.all_terms);
                }
            },
            error: function (xhr) {
                btn.html(btnText).prop('disabled', false);
                const error = xhr.responseJSON?.error || '–¢–µ—Ä–º–∏–Ω “õ–æ—Å—ã–ª–º–∞–¥—ã';
                Swal.fire({
                    icon: 'error',
                    title: '“ö–∞—Ç–µ',
                    text: error
                });
            }
        });
    }

    // Update datalist
    function updateDatalist(terms) {
        const datalists = $('#existing-terms, #existing-terms-add');
        datalists.empty();
        terms.forEach(term => {
            datalists.append(`<option value="${term}">`);
        });
    }
</script>
{% endblock %}